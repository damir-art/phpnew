# Работаем со сложной формой (отправка почты)
PHP не генерирует разметку, занимается лишь логикой.

Под сложной формой также понимается не только множество инпутов, но и например поставил галочку, форма поменялась, добавились удалились новые поля и т.п. Вообще любые формы работающие с POST запросом, лучше создавать так, даже самые простые.

Работаем с отправкой JSON данных от PHP файла (сервера) и получением их в скрипт PHP где расположена форма. Развитие скрипта `form-mail.md`, который значительно сократиться и упроститься, благодаря использованию JavaScript.

Теперь данные передаются и подгружаются без перезагрузки страницы (состояние элементов формы сохраняется, например введенные данные).

Тут PHP выступает как API. API принимает данные и возвращает на основе этих данных итоговый результат.  
Запрос на сервер отправляется в фоновом режиме.  
PHP занимается своим делом, не генерируя разметку и не думая о полях.

## index.php

    <?php
      /**
      * Файл содержащий форму
      */
    ?>

    <style>
      .form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-width: 400px;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
    </style>

    <div class="content">
      <form class="form" method="post">
        <div>
          <label>
            <div>Имя:</div>
            <div><input type="text" name="name"></div>
          </label>
        </div>
        <div>
          <label>
            <div>Телефон:</div>
            <div><input type="text" name="phone"></div>
          </label>
        </div>
        <div>
          <button>Отправить</button>
        </div>
      </form>
      <p class="err"></p>
    </div>

    <script>
    /**
    * Пишем JavaScript код который будет обрабатывать ответ от скрипта PHP
    * Функция FormData() в JavaScript используется для создания объекта,
    * который представляет собой набор пар ключ-значение, представляющих данные формы.
    * Этот объект можно отправить на сервер с помощью XMLHttpRequest или fetch().
    */

    let form = document.querySelector( '.form' );
    let err  = document.querySelector( '.err' );

    form.addEventListener( 'submit', function( evt ) {
      evt.preventDefault(); // запрет отправки формы

      // Тут можно создать код валидации элементов формы

      // Подготавливаем данные для отправки на скрипт PHP (тут же и получим ответ обратно)
      let formData = new FormData( form );
      // console.log( formData );

      fetch( 'send.php', {
        method: 'POST',
        body: formData
      })
      .then( response => response.json() )
      // .then( data => console.log( data ))
      .then( data => { 
        if ( data.res ) {
          form.innerHTML = "Ваша заявка отправлена!";
        } else {
          err.innerHTML = data.err;
        }
      });

    })
    </script>

## send.php

    <?php
    /**
    * Файл принимающий данные из формы
    * Принимать должен запросы только методом пост
    * И давать ответ, удалось отправить форму или нет
    * 
    * - форма принимает методом пост имя и телефон
    * - отдаёт в ответ какие либо данные, например в формате JSON
    * 
    * Данный файл теперь не генерирует разметку, а принимает данные из пост и отправляет данные обратно
    * Напрямую к этому файлу обратиться нельзя, потому что он работает с данными пост if( $_SERVER['REQUEST_METHOD'] === 'POST')
    */

    // узнаём какой метод отработал, если открывается страница то гет, если отправлена форма то пост
    // echo $_SERVER['REQUEST_METHOD'];
    // echo '<pre>';
    // print_r($_POST);
    // echo '</pre>';

    // Ответ от скрипта, массив JSON, который затем отправляется ответом
    // В скрипте обращаемся к массиву и изменяем его данные при необходимости
    // Затем отправляем его обратно на страницу где расположена форма
    $response = [
      'res' => false, // удалось отправить форму или нет
      'err' => false, // данные об ошибке
    ];

    if( $_SERVER['REQUEST_METHOD'] === 'POST') {
      $name = trim($_POST['name'] ?? '');
      $phone = trim($_POST['phone'] ?? '');
      
      if ( $name === '' || $phone === '' ) {
        // валидация на заполненность
        $response[ 'err' ] = "Заполните все поля!"; // выводим в шаблоне, под формой
      } elseif ( mb_strlen( $name, "UTF8" ) < 2 ) {
        // валиация на длину строки
        $response[ 'err' ] = "Имя должно быть 2 или более символов";
      } else {
        $dt = date('d-m-Y H:i:s'); // дата и время отправки сообщения
        $mainBody = "Дата: $dt\nТелефон: $phone\nИмя: $name"; // добавляем все переменные в одну для тела почты
        mail("admin@mail.ru", "Тема сообщения", $mainBody); // отправляем данные из форму на почту C:\xampp\mailoutput
        $response[ 'res' ] = true; // форма отправлена
      }
    }

    // Ответ скрипта
    echo json_encode($response);
    ?>
