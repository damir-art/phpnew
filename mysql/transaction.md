# Транзакция
Транзакция в MySQL - это группа последовательных операций с базой данных, которая представляет собой логическую единицу работы с данными. Она может быть выполнена либо целиком и успешно, соблюдая целостность данных и независимо от параллельно идущих других транзакций, либо не выполнена вообще, и тогда она не должна произвести никакого эффекта. Транзакции обрабатываются транзакционными системами, в процессе работы которых создаётся история транзакций. Различают последовательные (обычные), параллельные и распределённые транзакции. Распределённые транзакции подразумевают использование более чем одной транзакционной системы и требуют намного более сложной логики (например, two-phase commit — двухфазный протокол фиксации транзакции). Также в некоторых системах реализованы автономные транзакции, или подтранзакции, которые являются частью основной транзакции.

## Простыми словами
Представьте себе, что вы делаете покупки в интернет-магазине. Сначала вы кладете товары в корзину, затем переходите к оплате. На этапе оплаты деньги списываются с вашего счета, и товар отправляется на ваш адрес. Если вдруг что-то пошло не так (например, товар закончился на складе или возникли проблемы с оплатой), вся операция отменяется, и ваши деньги возвращаются обратно на счет.

Так вот, транзакция в MySQL работает примерно так же. Это набор действий, которые должны выполниться полностью и успешно, чтобы изменения вступили в силу. Если что-то идет не так, система откатывается назад, и никаких изменений не происходит.

Например, представьте, что вы хотите добавить нового клиента в базу данных и одновременно привязать ему банковскую карту. Эти два действия выполняются в рамках одной транзакции. Если одно из них завершится неудачно (например, ошибка при сохранении карты), то весь процесс будет отменен, и клиент не появится в системе.

Вот как это выглядит на практике:

```sql
-- Начало транзакции
START TRANSACTION;

-- Первое действие: добавляем клиента
INSERT INTO clients (name, email) VALUES ('Иван Иванов', 'ivan@example.com');

-- Второе действие: привязываем банковскую карту
INSERT INTO cards (client_id, card_number) VALUES (LAST_INSERT_ID(), '1234567890123456');

-- Завершаем транзакцию
COMMIT;
```

Если оба INSERT выполнились успешно, то транзакция фиксируется командой COMMIT, и изменения сохраняются в базе данных. Если возникла ошибка, например, номер банковской карты уже занят, то транзакция откатывается, и никакие изменения не сохранятся.

Таким образом, транзакции помогают поддерживать целостность данных и предотвращают ситуации, когда часть операции прошла успешно, а другая — нет.

## История транзакций
История транзакций в MySQL — это механизм, позволяющий отслеживать и восстанавливать состояние базы данных после сбоев или ошибок. В MySQL существует несколько уровней изоляции транзакций, которые определяют, каким образом изменения, сделанные в рамках одной транзакции, видны другим транзакциям. Рассмотрим основные аспекты истории транзакций в MySQL.

### Основные понятия

1. **Транзакция** — это последовательность операций с базой данных, которые должны быть выполнены как единое целое. Если какая-то часть транзакции не выполняется корректно, вся транзакция откатывается, и база данных возвращается в исходное состояние.

2. **Журнал транзакций (лог транзакций)** — это специальный файл, в котором хранятся все изменения, произведенные в ходе транзакций. Журнал транзакций используется для восстановления состояния базы данных в случае сбоя.

3. **Уровни изоляции транзакций** — это параметры, определяющие, каким образом изменения, сделанные в рамках одной транзакции, влияют на результаты других транзакций. В MySQL поддерживаются следующие уровни изоляции:
- READ UNCOMMITTED
- READ COMMITTED
- REPEATABLE READ
- SERIALIZABLE

### История транзакций

Когда начинается новая транзакция, MySQL создает запись в журнале транзакций. Эта запись содержит информацию о всех изменениях, которые были сделаны в рамках данной транзакции. Если транзакция успешно завершена (команда `COMMIT`), изменения фиксируются в базе данных, и журнал транзакций очищается. Если транзакция была отменена (команда `ROLLBACK`), все изменения откатываются, и журнал транзакций также очищается.

### Механизм восстановления

Если происходит сбой сервера или базы данных, MySQL использует журнал транзакций для восстановления состояния базы данных. Процесс восстановления проходит следующим образом:

1. **Анализ журнала транзакций.** MySQL просматривает журнал транзакций и определяет, какие транзакции были завершены, а какие остались незаконченными.

2. **Откат незавершенных транзакций.** Незавершенные транзакции откатываются, то есть все изменения, сделанные в рамках этих транзакций, аннулируются.

3. **Фиксация завершенных транзакций.** Завершенные транзакции фиксируются, то есть изменения, сделанные в рамках этих транзакций, окончательно записываются в базу данных.

### Пример использования транзакций

Рассмотрим простой пример использования транзакций в MySQL:

```sql
START TRANSACTION;

INSERT INTO users (name, email) VALUES ('Иван', 'ivan@example.com');
INSERT INTO orders (user_id, product_id) VALUES (LAST_INSERT_ID(), 1);

COMMIT;
```

В данном примере две команды `INSERT` выполняются в рамках одной транзакции. Если обе команды успешно выполнены, изменения фиксируются командой `COMMIT`. Если возникает ошибка при выполнении любой из команд, вся транзакция откатывается, и база данных остается в исходном состоянии.

### Заключение

История транзакций в MySQL обеспечивает надежность и целостность данных, позволяя безопасно выполнять сложные операции с базой данных. Благодаря механизму восстановления, даже в случае сбоев сервер или база данных могут вернуться в согласованное состояние, что крайне важно для большинства приложений.
