# SQL-инъекция
SQL-инъекция это попытка видоизменить запрос.

Борьба с SQL-инъекциями - подготовленные запросы (:маски).  

```php
// Борьба с SQL-инъекциями - подготовленные запросы (:маски)
$db = new PDO('mysql:host=localhost;dbname=php1simple','root','');
// $db->exec('SET NAMES UTF8');

$text = 'Hello 3'; // Текст берем из формы $_POST[ 'text' ]
$id = $_GET['id']; // id берём из адресной строки или через форму hiiden поля

$sql = "update messages set text = '$text' where id_message = '$id'";
$db->exec($sql);

// Примеры SQL инъекций
// Если в адресную строку вписать http://localhost/php/4/add.php?id=2 OR 1=1
// то данные изменятся везде, уберите одинарные кавычки у id_message = '$id', чтобы получилось
// 1=1 всегда даёт истину во всех строках
// Если в id_message = '$id' стоят кавычки, то взломать можно с помощью запроса
```

Способы борьбы с SQL-инъекциами:
Всегда надо помнить что данные получаемые от пользователя небезопасны.
- $id = (int)($_GET['id'] ?? ''); - данные приводим к числу, `where id_message = $id` (можно даже убрать одинарные кавычки), еще раз в url запросе прописываем `?id=2 OR 1=1`, теперь SQL инъекция не сработает, потому что строка `2 OR 1=1` приведена к числу `2`.

Еще пример, создадим еще один столбец в таблице:

```sql
ALTER TABLE `messages` ADD `status` TINYINT NOT NULL DEFAULT '0' AFTER `dt_add`; 
```
- статус 0 - новове сообщение
- 1 - промодерировано
- 2 - удалено

Сделаем промодерировано через адресную строку:

```php
// ?id=2&text=Привет всем!
$text = $_GET['text']; // Возьмём текст из GET параметра
$id = (int)($_GET['id'] ?? '');
```

```
<!-- Проставится статус 1 промодерировано через SQL-инъекцию -->
?id=2&text=Привет ',status='1
```

Как бороться с SQL-инъекциями?
- числа приводим к числу через (int)
- булев тип также
- дату проверяем на правильный формат
- если данные это произвольная строка и кавычка одинарная, то в данных запрещаем проставление одинарных кавычек или экранируем их при отправке в БД:
  - через регулярку проверяем есть ли в данных одинарная кавычка и удаляем её
  - если не удаляем, то можно экранировать `\'` ( PDO::qoute() )
  - лучше всего использовать подготовленные запросы (рекомендуется)

```php
$text = $db->quote($_GET['text']);
var_dump($_GET['text']);
var_dump($text);
```
