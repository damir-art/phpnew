# PDO
Функции PHP для работы с базой данных.
- PHP MySQL API - https://www.php.net/manual/ru/book.mysql.php (оригинальный, удален в PHP 7)
- PHP MySQLi API - https://www.php.net/manual/ru/book.mysqli.php (улучшенный)
- Объекты данных PHP - https://www.php.net/manual/ru/book.pdo.php (PDO)

PDO - отдельная абстракция. Код пишется сразу для всех видов СУБД.

## Описание PDO
PDO (PHP Data Objects) — это расширение для работы с базами данных в PHP, которое предоставляет унифицированный интерфейс для взаимодействия с различными СУБД (систем управления базами данных). В отличие от других решений, таких как MySQLi, PDO поддерживает множество различных типов баз данных, включая MySQL, PostgreSQL, SQLite, Oracle и другие.

### Основные преимущества PDO:

- **Поддержка разных баз данных**: Благодаря PDO вы можете легко переключаться между разными системами управления базами данных без необходимости переписывать код для работы с ними.
- **Безопасность**: PDO поддерживает подготовленные выражения (prepared statements), что помогает избежать SQL-инъекций.
- **Объектно-ориентированное программирование**: PDO позволяет работать с базой данных через объектный подход, что делает код более читаемым и удобным для поддержки.
- **Транзакции**: Поддерживает транзакционные операции, позволяя выполнять несколько запросов атомарно.

Теперь перейдем к практическим примерам использования PDO.

### Установка соединения

Для начала нужно установить соединение с базой данных. Вот пример подключения к базе данных MySQL:

```php
try {
  $dsn = 'mysql:host=localhost;dbname=testdb';
  $username = 'root';
  $password = '';

  // Устанавливаем соединение
  $pdo = new PDO($dsn, $username, $password);

  // Настраиваем режим обработки ошибок на исключения
  $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
  echo 'Ошибка подключения: ' . $e->getMessage();
}
```

В этом примере:
- `$dsn` — строка подключения, которая включает информацию о типе базы данных (`mysql`), хосте (`localhost`) и имени базы данных (`testdb`).
- `$username` и `$password` — данные для аутентификации.
- `setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION)` — устанавливает обработку ошибок в виде исключений, что упрощает работу с ошибками.

### Выполнение простых запросов

После установки соединения можно выполнять запросы к базе данных. Например, вот как выглядит выполнение простого SELECT-запроса:

```php
$sql = 'SELECT * FROM users WHERE id = :id';
$stmt = $pdo->prepare($sql);
$stmt->execute(['id' => 1]);
$user = $stmt->fetch(PDO::FETCH_ASSOC);
echo '<pre>';
print_r($user);
echo '</pre>';
```

Здесь мы используем подготовленное выражение (prepared statement):
- `prepare()` — подготавливает запрос.
- `execute()` — выполняет запрос, передавая параметры (в данном случае `['id' => 1]`).
- `fetch(PDO::FETCH_ASSOC)` — извлекает одну строку результата в виде ассоциативного массива.

### Подготовленные выражения и безопасность

Одним из главных преимуществ PDO является поддержка подготовленных выражений, которые помогают предотвратить SQL-инъекции. Рассмотрим пример вставки данных:

```php
$sql = 'INSERT INTO users (name, email) VALUES (:name, :email)';
$stmt = $pdo->prepare($sql);
$stmt->execute([
  ':name' => 'Иван Иванов',
  ':email' => 'ivan@example.com'
]);
```

Этот код безопасен, так как значения передаются отдельно от самого SQL-запроса, что предотвращает возможность внедрения вредоносных данных.

### Транзакции

PDO также поддерживает транзакции, что полезно при выполнении нескольких связанных операций. Вот пример использования транзакций:

```php
try {
  // Начинаем транзакцию
  $pdo->beginTransaction();
  
  // Выполняем первый запрос
  $stmt = $pdo->prepare('UPDATE accounts SET balance = balance - :amount WHERE account_id = :account_id');
  $stmt->execute([':amount' => 100, ':account_id' => 1]);
  
  // Выполняем второй запрос
  $stmt = $pdo->prepare('UPDATE accounts SET balance = balance + :amount WHERE account_id = :account_id');
  $stmt->execute([':amount' => 100, ':account_id' => 2]);
  
  // Если все прошло успешно, фиксируем изменения
  $pdo->commit();
  echo 'Транзакция завершена.';
} catch (PDOException $e) {
  // Откатываем изменения в случае ошибки
  $pdo->rollBack();
  echo 'Ошибка транзакции: ' . $e->getMessage();
}
```

### Закрытие соединения

Соединение с базой данных автоматически закрывается при завершении скрипта, но иногда может потребоваться закрыть его вручную:

```php
$pdo = null;
```

Это освобождает ресурсы, занятые соединением.

### Итог

PDO — мощный инструмент для работы с базами данных в PHP. Он обеспечивает безопасность, гибкость и удобство благодаря поддержке подготовленных выражений, транзакций и возможности работы с различными СУБД.
